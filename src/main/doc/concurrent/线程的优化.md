---
title: Java线程的优化
date: 2019-01-02
comments: true 
tags:
- 线程优化
categories:  
- Java并发  
---

## 为什么使用线程?
因为串行执行任务时，所有的任务节点必须按照顺序执行，如果处理任务时执行时间过长，可能会导致程序无响应。在这种情况下，线程就派上用处了。线程的主要目的是提高程序的运行性能。尽管使用多个线程可以提升整体性能，但与单个线程相比，多个线程使用总会引入额外的开销。如果多线程设计有误，实现某个功能时性能甚至比单线程的性能还差。所以在使用线程时评估好任务执行耗时，充分利用资源进行优化。

## 线程引入的开销有哪些?
在考虑使用多线程时，并行带来的性能提升必须要大于并发导致的性能开销，否则不要使用多线程。  
具体的线程开销有三种
1.上下文切换， 是指`CPU`从一个线程或进程切换到另一个线程或进程。 当线程执行时发生的阻塞越多，与`CPU`密集型的程序就会发生越多的上下文切换，从而增加线程的开销。   
2.内存同步，在使用`volatile`提供内存可见性时会使用一些特殊指令，即内存栅栏。内存栅栏可以刷新缓存，但是同样间接性的带来了性能上的影响，因为抑制了编译器的优化操作。在内存栅栏中，大多数操作是不能被重排序的。   
3.线程阻塞，线程的竞争会增加开销。在锁上发生竞争时，竞争失败的线程会阻塞。当线程无法获取某个锁或者线程等待或者产生`I/O`阻塞时，线程被挂起，这个过程包含两次额外的上下文切换。

## 怎样降低锁的竞争
串行操作会降低可伸缩性，并且上下文切换时也会降低性能。在锁上发生竞争会导致这些问题，因此减小锁的竞争能够提高性能和可伸缩性。
有三种方式可以降低锁的竞争程度：
1.减小锁的持有时间，尽可能的缩短锁的持有时间，例如将与锁无关的代码移出代码块，尤其是开销较大的，以及可能被阻塞的操作。
2.减小锁的粒度，降低单位时间内请求锁的次数，从而降低竞争的可能性。
3.锁分段，将锁分解技术进一步扩展对一组独立对象上的锁进行分解。
4.避免热点区。
5.放弃使用独占锁。例如使用并发容器，读写锁，不可变对象以及原子变量。


## 小结
程序的可伸缩性取决于所有代码中必须被串行执行的代码比例，我们可以通过以下方式来提高可伸缩性：
减少锁的持有时间，降低锁的粒度，采用非独占式的锁或非阻塞锁来代替独占锁。
