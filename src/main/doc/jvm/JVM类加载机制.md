---
title: JVM类加载机制
date: 2019-01-19
comments: true 
tags:
- JVM
categories:  
- Java虚拟机
---

## 类加载机制
虚拟机把描述的class文件加载到内存，并对数据进行校验、准备、解析和初始化，最终能够被形成被JVM可以直接使用的Java类型的过程，这就是虚拟机的类加载机制。   

## 类加载的生命周期
类从被加载到虚拟机内存开始，到卸载出内存结束包含七个阶段。包括加载，验证，准备，解析，初始化，使用，卸载。其中验证准备以及解析三个部分被称为连接。

## 类加载的过程

1). 加载阶段   
在加载阶段，虚拟机会通过类的全限定名来获取定义此类的二进制流。将字节流所代表的静态存储结构转换为方法区的运行时数据结构。在内存中生成一个代表这个类的`.class`对象，作为这个类的各种数据的访问人口。   

2). 验证阶段   
验证是连接阶段的第一步，目的是确保`.class`文件的字节流信息符合虚拟机的要求。   
验证阶段主要检验四个点：   
   文件格式校验(校验文件编码，校验文件常量引用等)   
   元数据验证(对字节码描述信息进行语义分析，例如类是否有父类(Object)，类继承时是否包含final修饰，以及类是否实现了接口的所有方法等等)   
   字节码验证(主要确定语义合法，变量类型转换有效等等)   
   符号引用验证(例如类中方法以及字段的引用是否有效，以及是否能够被访问到等等)   

3). 准备阶段   
准备阶段正式为类变量分配内存并且设置类变量的初始值，这些变量使用方法区的内存进行分配。值的一提的是准备阶段内存分配的仅包括被`static`修饰的变量，而不包括实例变量。
默认情况下初始值为零值，但是如果被`final`修饰的变量在这个阶段会将其置为定义的值。   

4). 解析阶段   
虚拟机将常量池内的符号引用替换为直接引用的过程叫做解析。   
   类或接口的解析   
   字段的解析   
   类方法解析   
   接口方法解析   
   
5). 初始化阶段   
类加载过程的最后一步称为类初始化阶段。初始化阶段是执行类构造器`<cinit>()`方法的过程，并且静态语句块只能访问到定义到静态语句块之前的变量。   

## 类加载器
类加载器用于加载类，并且对于任意一个类，被类加载器加载后都可以在虚拟机中确定唯一性。   
即便是同样的字节代码，被不同的类加载器加载之后所得到的类，也是不同的。       
通俗一点来讲，要判断两个类是否“相同”，前提是这两个类必须被同一个类加载器加载，否则这个两个类不“相同”。      
这里指的“相同”，包括类的`.class`对象的`equals()`方法、`isAssignableFrom()`方法、`isInstance()`方法、`instanceof`关键字等判断出来的结果。      

   
   
